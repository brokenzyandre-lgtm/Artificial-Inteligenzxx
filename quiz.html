<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kuis | QuantumQuiz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="card fade-in">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <h2 id="category-title">Memuat...</h2>
      <div class="timer-display" id="timer">60:00</div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>

    <div id="question-container">
      <p style="text-align:center; color:var(--gray);">Loading...</p>
    </div>

    <div id="options-container" style="margin-top:1.8rem;"></div>

    <div style="margin-top:2rem; display:flex; gap:1rem; justify-content:center;">
      <button id="prev-btn" class="btn secondary" disabled>← Sebelumnya</button>
      <button id="next-btn" class="btn" disabled>Lanjut →</button>
    </div>
  </div>

  <script src="data.js"></script>
  <script>
    let currentCategory = null;
    let currentIndex = 0;
    let userAnswers = {};
    let timeLeft = 3600; // 60 menit
    let timerId = null;

    function formatTime(sec) {
      return `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
    }

    function startTimer() {
      document.getElementById('timer').textContent = formatTime(timeLeft);
      timerId = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerId);
          finishQuiz();
          return;
        }
        timeLeft--;
        document.getElementById('timer').textContent = formatTime(timeLeft);
      }, 1000);
    }

    function selectRandomCategory() {
      const cat = quizData.categories[Math.floor(Math.random() * quizData.categories.length)];
      currentCategory = cat;
      document.getElementById('category-title').textContent = `Kategori: ${cat.name}`;
      loadQuestion(0);
    }

    function loadQuestion(index) {
      const q = currentCategory.questions[index];
      const container = document.getElementById('question-container');
      const opts = document.getElementById('options-container');

      container.innerHTML = `
        <h3>Soal ${index + 1} dari ${currentCategory.questions.length}</h3>
        <p style="font-size:1.3rem; margin:1.2rem 0;">${q.text}</p>
      `;

      opts.innerHTML = '';
      q.options.forEach((opt, i) => {
        const el = document.createElement('div');
        el.className = 'option';
        el.innerHTML = `<strong>${String.fromCharCode(65 + i)}.</strong> ${opt}`;
        el.dataset.idx = i;
        el.onclick = () => selectOption(el, i);
        opts.appendChild(el);
      });

      document.getElementById('prev-btn').disabled = index === 0;
      document.getElementById('next-btn').disabled = userAnswers[q.id] === undefined;
      
      const progress = ((index + 1) / currentCategory.questions.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    function selectOption(el, idx) {
      const q = currentCategory.questions[currentIndex];
      document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      userAnswers[q.id] = idx;
      document.getElementById('next-btn').disabled = false;
    }

    function next() {
      if (currentIndex < currentCategory.questions.length - 1) {
        currentIndex++;
        loadQuestion(currentIndex);
      } else {
        finishQuiz();
      }
    }

    function prev() {
      if (currentIndex > 0) {
        currentIndex--;
        loadQuestion(currentIndex);
      }
    }

    function finishQuiz() {
      clearInterval(timerId);
      const total = currentCategory.questions.length;
      let correct = 0;
      currentCategory.questions.forEach(q => {
        if (userAnswers[q.id] === q.correct) correct++;
      });
      const score = Math.round((correct / total) * 100);
      
      localStorage.setItem('quizResult', JSON.stringify({
        category: currentCategory.name,
        score,
        correct,
        total,
        timeUsed: 3600 - timeLeft
      }));
      
      window.location.href = 'certificate.html';
    }

    // Init
    if (!localStorage.getItem('userName')) {
      alert('⚠️ Nama tidak ditemukan. Kembali ke beranda.');
      window.location.href = 'index.html';
    }

    document.getElementById('next-btn').onclick = next;
    document.getElementById('prev-btn').onclick = prev;

    selectRandomCategory();
    startTimer();
  </script>
</body>
</html>